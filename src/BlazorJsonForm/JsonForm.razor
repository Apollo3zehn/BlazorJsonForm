@using Microsoft.AspNetCore.Components.Rendering
@using NJsonSchema
@using System.Text.Json.Nodes
@using System.Text.Json

<div style="display: flex; flex-direction: column;">
    @_renderFragement
</div>

@code {

    private RenderFragment _renderFragement = default!;

    /// <summary>
    /// The JSON schema to create a form for.
    /// </summary>
    [Parameter]
    public JsonSchema Schema { get; set; } = default!;

    /// <summary>
    /// The JSON data store.
    /// </summary>
    [Parameter]
    public JsonNode? Data { get; set; } = default!;

    /// <summary>
    /// The JSON data store event callback.
    /// </summary>
    [Parameter]
    public EventCallback<JsonNode?> DataChanged { get; set; }

    protected override void OnInitialized()
    {
        var sequence = 0;

        _renderFragement = builder =>
        {
            var oldData = Data;

            Data = Render(
                "Rocket settings", 
                Schema,
                Data,
                builder,
                ref sequence
            );

            if (JsonSerializer.Serialize(oldData) != JsonSerializer.Serialize(Data) && 
                DataChanged.HasDelegate)
            {
                DataChanged.InvokeAsync(Data);
            }
        };
    }

    private JsonNode? Render(
        string label, 
        JsonSchema schema, 
        JsonNode? data,
        RenderTreeBuilder builder, 
        ref int sequence
    )
    {
        switch (schema.Type)
        {
            case JsonObjectType.Integer:

                if (schema.Enumeration.Any())
                {
                    if (data is null)
                        data = string.Empty;

                    builder.OpenComponent<MudSelect<string>>(sequence++);
                    builder.AddComponentParameter(sequence++, "Label", label);

                    builder.AddComponentParameter(
                        sequence++,
                        "ChildContent",
                        new RenderFragment(builder =>
                        {
                            var sequence = 0;

                            for (int i = 0; i < schema.EnumerationNames.Count; i++)
                            {
                                builder.OpenComponent<MudSelectItem<string>>(sequence++);
                                builder.AddComponentParameter(sequence++, "Value", schema.EnumerationNames[i]);
                                builder.CloseComponent();
                            }
                        })
                    );

                    builder.CloseComponent();
                }

                else
                {
                    if (data is null)
                        data = 0;

                    builder.OpenComponent<MudNumericField<int>>(sequence++);
                    builder.AddComponentParameter(sequence++, "Label", label);
                    //builder.AddComponentParameter(sequence++, "Min", 0);
                    //builder.AddComponentParameter(sequence++, "Max", 10);
                    CreateBinding<int>(data, builder, ref sequence);
                    builder.CloseComponent();
                }

                break;

            case JsonObjectType.Number:

                if (schema.Format == "double")
                {
                    if (data is null)
                        data = 0.0;

                    builder.OpenComponent<MudNumericField<double>>(sequence++);
                    builder.AddComponentParameter(sequence++, "Label", label);
                    CreateBinding<double>(data, builder, ref sequence);
                    builder.CloseComponent();
                }

                else
                {
                    throw new Exception("schema.Format != \"double\" is not (yet) supported");
                }

                break;

            case JsonObjectType.String:

                if (data is null)
                    data = string.Empty;

                builder.OpenComponent<MudTextField<string>>(sequence++);
                builder.AddComponentParameter(sequence++, "Label", label);
                CreateBinding<string>(data, builder, ref sequence);
                builder.CloseComponent();

                break;

            case JsonObjectType.String | JsonObjectType.Null:

                if (data is null)
                    data = default;

                builder.OpenComponent<MudTextField<string>>(sequence++);
                builder.AddComponentParameter(sequence++, "Label", label);
                builder.CloseComponent();

                break;

            case JsonObjectType.Object:

                if (data is null)
                    data = new JsonObject();

                RenderObject(
                    label, 
                    schema.ActualProperties,
                    (JsonObject)data,
                    builder, 
                    ref sequence
                );

                break;

            case JsonObjectType.None:

                if (schema.OneOf.Count == 1)
                {
                    data = Render(
                        label,
                        schema.ActualSchema,
                        data,
                        builder, 
                        ref sequence
                    );
                }

                else
                {
                    throw new Exception("schema.OneOf.Count != 1 is not (yet) supported");
                }

                break;

            case JsonObjectType.Array:

                if (data is null)
                    data = new JsonArray();

                RenderArray(
                    label,
                    schema,
                    (JsonArray)data,
                    builder,
                    ref sequence
                );

                break;

            default:
                throw new Exception($"{schema.Type} is not (yet) supported");
        }

        return data;
    }

    private void RenderObject(
        string? title,
        IReadOnlyDictionary<string, JsonSchemaProperty> properties, 
        JsonObject data,
        RenderTreeBuilder builder,
        ref int sequence)
    {
        // Container
        builder.OpenElement(sequence++, "div");
        builder.AddAttribute(sequence++, "style", "display: flex; flex-direction: column; gap: 1rem; margin-left: 1rem; margin-top: 1rem; margin-bottom: 1rem;");

        // Title
        builder.OpenComponent<MudText>(sequence++);
        builder.AddAttribute(sequence++, "Typo", Typo.h6);

        builder.AddAttribute(sequence++, "ChildContent", new RenderFragment(builder => builder.AddContent(1, title)));
        builder.CloseElement();

        // Properties
        foreach (var entry in properties)
        {
            var (name, propertySchema) = entry;
            var label = propertySchema.Description ?? name;

            data.TryGetPropertyValue(name, out var propertyData);

            data[name] = Render(
                label, 
                propertySchema,
                propertyData,
                builder, 
                ref sequence
            );
        }

        builder.CloseElement();
    }

    private void RenderArray(
        string? title,
        JsonSchema schema,
        JsonArray data,
        RenderTreeBuilder builder,
        ref int sequence)
    {
        // Container
        builder.OpenElement(sequence++, "div");
        builder.AddAttribute(sequence++, "style", "display: flex; flex-direction: column; gap: 1rem; margin-left: 1rem; margin-top: 1rem; margin-bottom: 1rem;");

        // Title
        builder.OpenComponent<MudText>(sequence++);
        builder.AddAttribute(sequence++, "Typo", Typo.h6);

        var capturedSequence = sequence++;
        builder.AddAttribute(sequence++, "ChildContent", new RenderFragment(builder => builder.AddContent(capturedSequence, title)));
        builder.CloseElement();

        // 'Add' button
        {
            builder.OpenComponent<MudIconButton>(sequence++);
            builder.AddComponentParameter(sequence++, "Icon", Icons.Material.Filled.Add);
            builder.CloseComponent();
        }

        builder.CloseElement();
    }

    private void CreateBinding<T>(JsonNode data, RenderTreeBuilder builder, ref int sequence)
    {
        builder.AddComponentParameter(sequence++, "Value", data.GetValue<T>());

        builder.AddComponentParameter(
            sequence++, 
            "ValueChanged", 
            EventCallback.Factory.Create<T>(
                this,
                value => 
                {
                    data.ReplaceWith(value);

                    if (DataChanged.HasDelegate)
                        DataChanged.InvokeAsync(Data);
                }
            )
        );
    }
}